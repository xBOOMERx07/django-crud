{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="mb-4">
                <a href="{% url 'lista_ventas_garage' %}" class="btn btn-secondary">
                    <i data-lucide="arrow-left"></i> Volver a la lista
                </a>
            </div>
            
            <div class="card">
                <div class="card-body p-4">
                    <h2 class="mb-4">
                        <i data-lucide="shopping-bag" style="width: 32px; height: 32px; vertical-align: middle;"></i>
                        {{ action }} Producto
                    </h2>
                    
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Foto del Producto -->
                        <div class="mb-4 text-center">
                            <label class="form-label">
                                <i data-lucide="image"></i> Foto del Producto
                            </label>
                            
                            <div id="preview-container" class="mb-3">
                                {% if producto.foto_producto %}
                                <img id="preview-image" src="{{ producto.foto_producto.url }}" alt="Foto actual" 
                                     style="width: 100%; max-width: 400px; height: 300px; object-fit: cover; border-radius: 12px; border: 2px solid var(--border-light);">
                                {% else %}
                                <div id="preview-image" style="width: 100%; max-width: 400px; height: 300px; border-radius: 12px; background: var(--bg-secondary); margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-light);">
                                    <i data-lucide="image" style="width: 80px; height: 80px; color: var(--text-secondary);"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div id="drop-zone" style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 2rem; cursor: pointer; transition: all 0.3s ease;">
                                <i data-lucide="upload-cloud" style="width: 48px; height: 48px; color: var(--accent-primary); margin-bottom: 1rem;"></i>
                                <p class="mb-2">Arrastra la foto aquí o haz clic para seleccionar</p>
                                <small class="text-muted">JPG, PNG, GIF (máx. 5MB)</small>
                            </div>
                            
                            <input type="file" class="form-control mt-2" name="foto_producto" id="foto_producto" 
                                   accept="image/*" style="display: none;">
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i data-lucide="tag"></i> Nombre del Producto *
                            </label>
                            <input type="text" class="form-control" name="nombre_producto" 
                                   value="{{ producto.nombre_producto|default:'' }}" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i data-lucide="check-circle"></i> Estado *
                                </label>
                                <select class="form-control" name="estado_producto" required>
                                    <option value="Bueno" {% if producto.estado_producto == 'Bueno' %}selected{% endif %}>Bueno</option>
                                    <option value="Regular" {% if producto.estado_producto == 'Regular' %}selected{% endif %}>Regular</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i data-lucide="dollar-sign"></i> Precio *
                                </label>
                                <input type="number" step="0.01" class="form-control" name="valor_del_bien" 
                                       value="{{ producto.valor_del_bien|default:'0.00' }}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i data-lucide="file-text"></i> Descripción *
                            </label>
                            <textarea class="form-control" name="descripcion" rows="4" required>{{ producto.descripcion|default:'' }}</textarea>
                            <small class="text-muted">Describe el producto, condiciones, etc.</small>
                        </div>
                        
                        {% if producto %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="vendido" id="vendido"
                                   {% if producto.vendido %}checked{% endif %}>
                            <label class="form-check-label" for="vendido">
                                <i data-lucide="check"></i> Marcar como vendido
                            </label>
                        </div>
                        {% endif %}
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" name="activar_para_que_se_vea_en_front" 
                                   id="activar" {% if not producto or producto.activar_para_que_se_vea_en_front %}checked{% endif %}>
                            <label class="form-check-label" for="activar">
                                <i data-lucide="eye"></i> Mostrar en CV público
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i data-lucide="save"></i> Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('foto_producto');
        const previewImage = document.getElementById('preview-image');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--accent-primary)';
            dropZone.style.backgroundColor = 'rgba(37, 99, 235, 0.1)';
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'var(--border-light)';
            dropZone.style.backgroundColor = 'transparent';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border-light)';
            dropZone.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                previewFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewFile(e.target.files[0]);
            }
        });
        
        function previewFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (previewImage.tagName === 'IMG') {
                    previewImage.src = e.target.result;
                } else {
                    const img = document.createElement('img');
                    img.id = 'preview-image';
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100%; max-width: 400px; height: 300px; object-fit: cover; border-radius: 12px; border: 2px solid var(--border-light);';
                    previewImage.parentNode.replaceChild(img, previewImage);
                }
            };
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}